\chapter{Autonomes Ladeverhalten} \label{kap:AutonomesLadeverhalten}

\section[Anfahren der Ladestation]{Anfahren der Ladestation\hfill {\normalsize A.G.}} %TODO: Andi G.

Damit der AMiRo sich in der Ladestation aufladen kann, muss diese zunächst lokalisiert und angefahren werden. Hierbei dient der komplette Schaukasten als Bewegungsfläche und der Schaukastenrand als Begrenzung dieser Fläche. Für die Suche kann der AMiRo auf unterschiedliche Strategien und Verfahren zurückgreifen. Als Suchstrategien existiert zum einen eine Positionsabschätzung über die Kamerabilder der Umgebung, um den kürzesten Pfad zum Schaukastenrand zu berechnen. Zum anderen kann der AMiRo sich in die aktuelle Richtung bewegen und auf gut Glück den Schaukastenrand finden. Als Verfahren zum Anfahren der Ladestation wird entweder auf die Kamera oder auf die Infrarotsensoren am Boden des AMiRo's zurückgegriffen.

In der Abbildung \ref{fig:searchStationFSM} ist die Finite-State-Machine der Lokalisation und des Anfahren der Ladestation aufgeführt. Diese lokale State-Machine wird durch die globale Finite-State-Machine angestoßen, welche im Abschnitt \ref{cha:Finite-State-Machine} vorgestellt wird. In der Abbildung wird diese als \texttt{showcaseFSM} beschrieben. Wird das Anfahren der Ladestation aktiviert, beginnt es zunächst aus dem Zustand \texttt{Idle}. Mit der Aktivierung wird eine Information zum weiteren Verlauf mitgegeben. Entweder soll sich der AMiRo zum Schaukastenrand bewegen oder die Ladestation anfahren. Letzteres wird ausgeführt, wenn sich der AMiRo bereits am Schaukastenrand befindet. Dort muss er bei eventuell besetzter Ladestation warten. Aus diesem Grund kann diese lokale State-Machine in zwei Kernabschnitte betrachtet werden, die in der Abbildung als rote Kästen dargestellt sind. Ein beispielhaftes Szenario ist in Abbildung \ref{fig:searchStationExample} visualisiert, wobei der rote Pfeil zum Schaukastenrand den ersten Kernabschnitt und der rote Pfeil zur Ladestation den zweiten Kernabschnitt repräsentiert.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=.45]{searchSationExample.png} 	
		\caption{Aufsuchen der Ladestation}
		\label{fig:searchStationExample}
	\end{center}
\end{figure}

Im ersten Kernabschnitt (oberer roter Kasten in Abb. \ref{fig:searchStationFSM}) soll sich der AMiRo zum Schaukastenrand bewegen. Dabei ruft der Zustand \texttt{Idle} den Zustand \texttt{Initialization} auf. Hier werden für das Lokalisieren und Anfahren Parameter initialisiert und entschieden, welche Suchstrategie ausgeführt wird. Soll der AMiRo lediglich in seine aktuelle Orientierung fahren, wird ohne Weiteres der Zustand \texttt{moveAndCollAvoid} aufgerufen. Hierbei fährt er in seine aktuelle Orientierung bis die Kollisionsvermeidung greift. 

Soll hingegen eine intelligentere Suchstrategie angewendet werden, wechselt die State-Machine in den Zustand \texttt{checkPosition}. Der AMiRo rotiert hier einmalig vollständig um seine eigene Achse, während Kamerabilder von der Umgebung aufgenommen werden. Über die Bilder läuft der \textit{SimpleBlobDetector} der OpenCV-Programmbibliothek, wobei das Bild zunächst vorverarbeitet wird. Bei der Vorverarbeitung wird pixelweise entschieden, ob der aktuelle Bildpunkt in einem bestimmten Farbwertrahmen fällt oder nicht. Bei zutreffender Bedingung behält der Pixel seinen Farbwert, andernfalls wird er weiß eingefärbt. Damit bietet es dem \textit{SimpleBlobDetector} eine kontrastreiche Vorlage, um Elemente im Kamerabild zu detektieren. Wurde ein Torpfostenpaar und optional die Ladestation detektiert, werden zum einen jeweils die Orientierung der Odometrie gespeichert. Zum anderen werden jeweils Minimum und Maximum der X- und Y-Koordinate beider Torpfosten errechnet. Mit diesen Informationen wechselt die State-Machine in den Zustand \texttt{goalDetected}, ansonsten direkt in den Zustand \texttt{moveAndCollAvoid}.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=.7]{searchStationFSM.pdf} 	
		\caption{Finite-State-Machine zur Lokalisation der Ladestation}
		\label{fig:searchStationFSM}
	\end{center}
\end{figure}

Das Vorgehen zur Berechnung der nächsten Kante in \texttt{goalDetected} wird in Abschnitt \ref{cha:Lokalisation der Ladestation} erläutert. Nachdem sich der AMiRo zur nächsten Kante orientiert hat, wird ebenfalls der Zustand \texttt{moveAndCollAvoid} aufgerufen. In diesem Zustand bewegt sich der AMiRo geradeaus, entweder eine definierte oder unbegrenzte Strecke. Im ersteren Fall wird eine neue Position angefahren, da die Detektion der Torpfosten an der alten Position nicht erfolgreich war. Damit wechselt die State-Machine in den Zustand \texttt{Idle} und beginnt von vorne. Die Anzahl der Versuche ist hierbei einstellbar, sodass der AMiRo zur Not die aktuelle Orientierung anfährt. Dies entspricht dem zweiten Fall, der unbegrenzten Strecke. Mit einer Kollisionsvermeidung wird anschließend das aktuelle Hindernis vorerst als Schaukastenrand interpretiert. Damit endet der erste Kernabschnitt der lokalen State-Machine und sendet ein Signal an die \texttt{showcaseFSM}.

Der zweite Kernabschnitt (unterer roter Kasten in Abb. \ref{fig:searchStationFSM}) befasst sich mit dem Anfahren der Ladestation. Dazu wird ausgehend vom Zustand \texttt{Idle} mit der Information der \texttt{showcaseFSM} der Zustand \texttt{edgeFollowing} angestoßen. Die durchzuführende Kantenverfolgung ist in Abbildung \ref{fig:edgeFollowing} dargestellt. Ausgehend von einer erfolgreichen Detektion der Ladestation im ersten Kernabschnitt, wird zunächst die Richtung der Kantenverfolgung gesetzt. Das bedeutet den kürzesten Pfad zur Ladestation entweder im oder gegen den Uhrzeigersinn. Des weiteren wird mithilfe der Infrarotsensoren seitlich am AMiRo versucht einen bestimmten Abstand zum Schaukastenrand einzuhalten. Hierbei wird permanent überprüft, ob die Sensoren einen minimalen oder maximalen Schwellwert überschreiten. Trifft dies zu, wird ein entsprechender Rotationswert (links/rechts) angelegt. Befindet sich der Sensorwert zwischen min. und max. Schwellwert, bewegt sich der AMiRo geradeaus. Parallel wird dazu die Orientierung der Odometrie zur Kantenüberprüfung aufsummiert. Erreicht die Summe einen zu hohen Wert, befindet sich der AMiRo nicht an der Kante, da die Innenwinkelsumme eines Rechteckes $360^\circ$ beträgt. Damit wechselt der Miniroboter zurück zum Zustand \texttt{moveAndCollAvoid} und sucht ein neues Hindernis bzw. Kante.

Nachdem (für den Moment) Motorwerte zur Kantenverfolgung eingestellt sind, wechselt die State-Machine in den Zustand \texttt{cam/infrared detectStation}. An dieser Stelle wird ein Verfahren zur Detektion der Ladestation verwendet, mittels Kamera oder Infrarotbodensensoren.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=.6]{edgeFollowing.png} 	
		\caption{Kantenverfolgung und Anfahren der Ladestation}
		\label{fig:edgeFollowing}
	\end{center}
\end{figure}

Die Detektion über das Kamerabild verläuft sehr ähnlich zur Detektion der Torpfosten im ersten Kernabschnitt. Wiederholt wird das Kamerabild vorverarbeitet und der \textit{SimpleBlobDetector} zur Erkennung der schwarzen Markierungen der Ladestation verwendet. Sind keine passenden Elemente detektiert worden, wechselt die State-Machine zurück in den Zustand \texttt{edgeFollowing}. Dies geschieht solange in einer Schleife, bis beide schwarzen Markierungen detektiert worden sind. Ab diesem Punkt richtet sich der AMiRo mit dem Bildmittelpunkt (X-Achse) zur Ladestation aus und fährt sie direkt an. Weiterhin im aktuellen Zustand verweilend, wird durchgängig über die seitlichen Infrarotsensoren der Abstand vor dem Miniroboter überprüft. Durch die Überschreitung eines Schwellwertes befindet sich der AMiRo in der Ladestation und wechselt zum Zustand \texttt{switchToUc}.

Ein zweites Verfahren ist die Detektion über die Infrarotbodensensoren. In Abbildung \ref{fig:edgeFollowing} ist eine schwarze Bodenmarkierung an der Ladestation ersichtlich. Wie bei der Detektion mit dem Kamerabild, wechselt die State-Machine solange zwischen diesem Zustand und dem Zustand \texttt{edgeFollowing}, bis die Infrarotsensoren am Boden einen Schwellwert überschreiten. An dieser Stelle wird die Geschwindigkeit gedrosselt und der AMiRo richtet sich zur Ladestation aus. Sobald die seitlichen Bodensensoren die schwarze Fläche detektieren, wird der Miniroboter nochmals zur Ladestation ausgerichtet. Des weiteren bewegt er sich langsam zur Station und sobald die vorderen (Ringsensoren) einen Schwellwert überschreiten, befindet sich der AMiRo in der Ladestation und wechselt zum Zustand \texttt{switchToUc}.

Der Zustand \texttt{switchToUc} ist der finale Zustand in dieser State-Machine. Hier werden Parameter zurückgesetzt und das erfolgreiche Anfahren der Ladestation durch Lichter visualisiert. Ein Signal an \texttt{showcaseFSM} beendet den zweiten Kernabschnitt.

\section[Lokalisation der Ladestation durch Positionsabschätzung]{Lokalisation der Ladestation durch Positionsabschätzung\hfill {\normalsize A.G.}} \label{cha:Lokalisation der Ladestation}
Da der Begriff \textit{autonom} ein gewisses intelligentes Verhalten für die Selbstständigkeit mit sich zieht, ist eine zufällige Suche der Ladestation nicht optimal. Aus einer Menge vieler möglichen Strategien wurde die Berechnung der nächsten Kante und die darauffolgende kürzeste Strecke zur Ladestation gewählt. 





\section[Finite-State-Machine des DiWheelDrive-Microcontrollers]{Finite-State-Machine des DiWheelDrive-Microcontrollers\hfill {\normalsize J.E. \& T.M.}} %TODO: Julian E. & Timo M.

Nachdem die Ladestation erfolgreich angefahren wurde, wird durch eine CAN-Nachricht dem DiWheelDrive-Board signalisiert, dass die weiteren Schritte des Einparkens eingeleitet werden sollen.
Auf dem Microcontroller wird eine State-Machine ausgeführt, die so lange im \textit{IDLE}-Zustand wartet, bis das Ladeverhalten angetriggert wird (siehe Abb. \ref{fig:uC_statmachine}).
Der nächste Zustand ist \textit{MOVE INTO STATION}, welcher in Kapitel \ref{kap:einparken_ladestation} erläutert wird. Ist dies erfolgreich abgeschlossen, so folgen die Zustände \textit{TURN AROUND} und \textit{ADJUST POSITION}, welche in Kapitel \ref{kap:andocken_ladestation} erklärt werden. Anschließend wird der Ladevorgang des AMiRos gestartet und überwacht. Dies geschieht in den Zuständen \textit{INITIATE CHARGING} und \textit{CHARGING}. Diese sind im Kapitel \ref{kap:ladevorgang} beschrieben.

Sollte ein Zustand nicht erfolgreich ausgeführt werden können, so gibt es definierte Routinen, die abermals ausgeführt werden müssen. Sollte die CAN-Nachricht für einen Abbruch des Ladevorganges eingehen, so wird dieser sofort unterbrochen und die State-Machine wird in den \textit{IDLE}-Zustand versetzt.

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=0.4\textwidth]{uC_statemachine.pdf} 	
		\caption{Finite-State-Machine des DiWheelDrive-Microcontrollers}
		\label{fig:uC_statmachine}
	\end{center}
\end{figure}

\section[Einparken in der Ladestation]{Einparken in der Ladestation\hfill {\normalsize J.E.}}\label{kap:einparken_ladestation} %TODO: Julian E.

\section[Andocken an die Ladestation]{Andocken an die Ladestation\hfill {\normalsize T.M.}}\label{kap:andocken_ladestation} %TODO: Timo M.
Nachdem der AMiRo erfolgreich in der Ladestation eingeparkt ist werden anschließend die Ladepins auf der Rückseite des Roboters zu den Ladekontakten der Station ausgerichtet. Dabei ist es notwendig, dass alle Pins die Kontakte berühren, da es bei Stromspitzen sonst zu Schäden am AMiRo kommen könnte.

Als ersten Schritt wird zunächst eine 180$^\circ$ Drehung durchgeführt, durch die der AMiRo grob in die Ladeposition gedreht wird. Die Drehung wird anhand der Odometriedaten des Roboters durchgeführt. Dabei kann eine gewünschte Fehlertoleranz als Argument übergeben werden. Da eine exakte Drehung um 180$^\circ$ kompliziert ist, wird hier eine Fehlertoleranz von 5$^\circ$ eingeräumt, damit die Drehung schnell durchgeführt werden kann und der AMiRo nicht die Position mehrfach verbessern muss, bis exakt 180$^\circ$ erreicht sind. Diese Toleranz hat auf das anschließende Justieren der Position keine Auswirkungen.

Für die Justierung der Ladeposition des AMiRos werden die Daten der beiden hinteren Abstandssensoren genutzt. Um diese zur Ausrichtung des Roboters nutzen zu können, wurden an der Station zwei schwarze Streifen angebracht (siehe Abb. \ref{fig:charging_station}). Diese bieten einen hohen Kontrast für die UV-Sensoren im Vergleich zur weißen Station. So liefern die Sensoren den maximalen Wert von 0xFFFF, wenn sie sich direkt vor der weißen Ladestation befinden und einen im Vergleich sehr niedrigen Wert von unter 0x2000, wenn sie den Abstand zu einen schwarzen Klebestreifen messen. 
Die Klebestreifen sind so angebracht, dass sich beide hinteren Abstandssensoren genau vor einer weißen Fläche befinden, wenn die Ladeposition erreicht ist. 
Das heißt, dass die Position des AMiRos so lange justiert werden muss, bis beide Sensoren den Wert 0xFFFF liefern. 
Dafür werden die Werte der Abstandssensoren ausgelesen und anhand dieser wird nun unterschieden in welcher Position sich der AMiRo befindet und welches der nächste Schritt ist, um die Ladeposition zu erreichen. 

\begin{figure}[]
	\begin{center}
		\includegraphics[width=0.6\textwidth]{charging_station_stripes.jpg} 	
		\caption{Ladestation mit Klebestreifen}
		\label{fig:charging_station}
	\end{center}
\end{figure}

Sollte einer der beiden Sensoren 0xFFFF als Wert liefern und der andere einen zu 0xFFFF abweichenden Wert, so steht der AMiRo direkt vor der Wand der Station, muss aber noch in die Richtung des Sensors mit vollem Ausschlag gedreht werden. Da der Magnet der Station eine hohe Anziehung auf die hintere Befestigungsschraube des AMiRos ausübt, ist es nicht möglich den Roboter durch minimales Ansteuern der PWM\footnote{Pulsweitenmodulation}-Steuerung der Motoren zu drehen. Deshalb fährt der Roboter ein kleines Stück aus der Station heraus um sich anschließend in die gegebene Richtung in die Station hinein zu bewegen. 
Wenn ein Sensor einen Wert über 0x4000 und der andere unter 0x4000 liefert, bedeutet dies, dass sich der AMiRo mit einem Abstand vor der Station befindet und seine Position außerdem ein wenig verdreht ist. In dieser Situation muss sich der Roboter in die Richtung des Sensors mit höherem Wert drehen und sich auf die Station zu bewegen. 
Geben beide Sensoren einen Wert über 0x4000 aus, so steht der AMiRo mit Abstand zur Station, muss jedoch nicht gedreht werden. In diesem Fall wird eine gerade Bewegung in Richtung der Station ausgeführt. 
Sollten beiden Sensoren einen Wert unter 0x4000 liefern, so steht der AMiRo in einem zu hohen Abstand zur Ladestation und das Einparken in die Ladestation wird nochmals eingeleitet.

Bevor der Ladevorgang eingeleitet wird, wird die Position des AMiRos nochmals überprüft. Hierfür werden die aktuellen Odometriedaten des Roboters abgerufen und gespeichert. Anschließend wird die PWM-Steuerung der Motoren deaktiviert, was zur Folge hat, dass sich die Reifen frei drehen können. Sollte der AMiRo noch nicht korrekt zur Ladestation ausgerichtet sein, kann die Position des Roboters durch die Wirkung des Magneten auf die Befestigungsschraube verändert werden. Dabei werden die aktuellen Odometriewerte mit den gespeicherten abgeglichen. Sollte sich nach einer Sekunde keine Änderung der Position ergeben haben, so wird eine korrekte Ladeposition angenommen und der Ladevorgang gestartet. Sollte sich die Odometrie verändern, so wird das Justieren nochmals eingeleitet. 




%- Ausgangssituation: AMiRo steht vorwärts in der Ladestation
%- 180$^\circ$ Drehung anhand der Odometrie um die Ladepins zur Station zu richten
%- Justierung der Position anhand der Abstandssensoren und der schwarzen Streifen
%- Abschalten der PWM und Überwachung, ob sich die Position ändert 
%	- Mögliche Fehlerquellen für Positionsänderung: 
%		- AMiRo wird durch den Einfluss des Magnetfeldes auf die Schraube gedreht, da die Position noch nicht gut genug justiert ist
%		- AMiRo wird durch die Federung der Ladepins von der Station abgestoßen, da die Schraube nicht genau vor dem Magneten war und somit die magnetische Kraft nicht groß genug war 

\section[Ansteuern und Überwachen des Ladevorgangs]{Ansteuern und Überwachen des Ladevorgangs\hfill {\normalsize T.M.}}\label{kap:ladevorgang} %TODO: Timo M.

Sobald der AMiRo mit seinen Ladepins zu den Ladekontakten der Ladestation ausgerichtet ist, kann der Ladevorgang eingeleitet werden.
Zunächst wird dem PowerManagement-Board signalisiert, dass der DiWheelDrive-Ladepfad aktiviert werden soll. Nun wird kontrolliert, ob wirklich mindestens 9V an den Pins anliegen und die Akkus aufgeladen werden. Hierfür wird eine kurze Zeit gewartet, da es aufgrund von Signalfilterungen bei der Ermittlung der anliegenden Spannung zu Verzögerungen kommt. Sollten anschließend keine 9V anliegen und die Akkus nicht geladen werden, so wird der Ladevorgang abgebrochen und die Position des AMiRos zur Station wird nochmals justiert.
Liegt die Spannung an und die Akkus werden geladen, so wird während des Ladevorgangs der Status mittels LEDs visualisiert (siehe Abb. \ref{fig:amiro_charging}). 
Währenddessen wird außerdem auf die Odometriedaten des AMiRos geachtet, denn sollte sich etwas an der Position des Roboters ändern, ist nicht mehr sichergestellt, dass alle Pins die Ladekontakte berühren und der Ladevorgang wird abgebrochen. Ein Grund hierfür könnten äußere Einwirkungen wie ein Wackeln am Schaukasten sein.

Nachdem die Akkus des AMiRos voll geladen sind wird der DiWheelDrive-Ladepfad deaktiviert, die PWM-Steuerung aktiviert und der Roboter fährt ein Stück aus der Ladestation heraus.

\begin{figure}[]
	\begin{center}
		\includegraphics[width=0.5\textwidth]{AMiRo_charging.jpg} 	
		\caption{Ladeanimation}
		\label{fig:amiro_charging}
	\end{center}
\end{figure}



%- Aktivieren des DiWheelDrive-Board Ladepfades (+ kurzes Abwarten)
%- Kontrolle, ob mehr als 9V anliegen (wenn nicht -> Position erneut justieren)
%- Überwachen des Ladevorgangs
%	- Auslesen der Ladestatus der Akkus (\% und Zeit bis geladen)
%	- Überwachen der Odometrie 
%		- falls sich der AMiRo aufgrund von äußeren Einwirkungen bewegen sollte -> Abbruch des Ladevorgangs und Position erneut justieren

